name: Sync Fork

permissions:
  contents: write

on:
  schedule:
    - cron: '0 16 * * *' # 每天UTC时间16点（北京时间零点）自动同步
  workflow_dispatch:  # 允许手动触发

jobs:
  sync_with_upstream:
    name: Sync with Upstream
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Backup sync workflow
        run: |
          mkdir -p /tmp/workflow_backup
          # 若本地不存在，则用 workflow 自身的源码路径备份
          if [ -f .github/workflows/sync.yaml ]; then
            cp .github/workflows/sync.yaml /tmp/workflow_backup/sync.yaml
          else
            cp ${{ github.workflow }} /tmp/workflow_backup/sync.yaml || echo "Backup from workflow context skipped."
          fi

      - name: Set up git config
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Add upstream and fetch
        run: |
          git remote add upstream https://github.com/dataabc/weiboSpider.git
          git fetch upstream

      - name: Hard reset to upstream/master
        run: |
          git checkout master
          git reset --hard upstream/master

      - name: Restore sync workflow
        run: |
          mkdir -p .github/workflows
          cp /tmp/workflow_backup/sync.yaml .github/workflows/sync.yaml

          git add .github/workflows/sync.yaml
          git commit -m "Restore sync workflow after upstream sync" || echo "No changes to commit"

      - name: Push to origin master (force)
        run: git push origin master --force

      - name: Check for successful sync
        if: success()
        run: echo "Sync completed successfully and workflow restored."

      - name: Check for Failure
        if: failure()
        run: |
          echo "[Error] Sync failed. This might be due to:"
          echo "1. Changes in the upstream workflow file"
          echo "2. Merge conflicts that need manual resolution"
          echo "3. Network issues"
          echo "Please check the logs and consider manual sync if needed."
          exit 1
